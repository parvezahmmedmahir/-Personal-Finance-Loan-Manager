<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record Payment - ALI Finance Manager</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 90;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 200ms ease-out;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 300ms ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                transform: translateY(20px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .loan-context-card {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            border-radius: 8px;
            padding: 1rem;
            color: white;
        }

        .payment-type-option {
            cursor: pointer;
            transition: all 150ms ease;
            border: 2px solid #e5e7eb;
        }

        .payment-type-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .payment-type-option.selected {
            border-color: #1e3a8a;
            background: #dbeafe;
        }

        .payment-type-option.selected .type-icon {
            color: #1e3a8a;
        }

        .currency-input-wrapper {
            position: relative;
        }

        .currency-symbol {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-weight: 500;
        }

        .currency-input {
            padding-left: 40px;
        }

        .balance-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .error-message {
            display: none;
            padding: 0.75rem;
            background: #fee2e2;
            border: 1px solid #dc2626;
            border-radius: 6px;
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .error-message.show {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: slideDown 200ms ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .success-animation {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .success-animation.show {
            display: flex;
            animation: fadeIn 200ms ease-out;
        }

        .success-checkmark {
            width: 80px;
            height: 80px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: scaleIn 300ms ease-out;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
            }
            to {
                transform: scale(1);
            }
        }

        .date-input {
            position: relative;
        }

        .date-input input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.6;
        }

        .date-input input[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        /* Bengali number support */
        .bengali-number {
            font-family: 'Kalpurush', 'Noto Sans Bengali', sans-serif;
        }

        /* Scrollbar styling */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
  
  <script type="module" async src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Falifinanc7595back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.10"></script>
  <script type="module" defer src="https://static.rocket.new/rocket-shot.js?v=0.0.1"></script>
  </head>
<body class="bg-background">
    <!-- Modal Backdrop -->
    <div class="modal-backdrop" id="modalBackdrop">
        <!-- Modal Content -->
        <div class="modal-content" id="modalContent">
            <!-- Modal Header -->
            <div class="sticky top-0 bg-white border-b border-border px-6 py-4 flex items-center justify-between z-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <i class="fas fa-money-bill-wave text-white text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold text-text-primary" id="modalTitle">Record Payment</h2>
                        <p class="text-sm text-text-secondary" id="modalSubtitle">Add a new payment entry</p>
                    </div>
                </div>
                <button 
                    type="button" 
                    id="closeModal"
                    class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors text-text-secondary hover:text-text-primary"
                    aria-label="Close modal"
                >
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                <!-- Loan Context Card -->
                <div class="loan-context-card">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg mb-1" id="loanName">Personal Loan</h3>
                            <div class="flex items-center gap-2 text-sm opacity-90">
                                <i class="fas fa-user text-xs"></i>
                                <span id="lenderName">Md. Rahman</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs opacity-75 mb-1" id="balanceLabel">Current Balance</p>
                            <p class="text-2xl font-bold" id="currentBalance">৳ 50,000</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 text-sm pt-3 border-t border-white border-opacity-20">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-calendar-alt text-xs"></i>
                            <span id="loanStartDate">01/01/2025</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-percentage text-xs"></i>
                            <span id="interestRate">12% p.a.</span>
                        </div>
                    </div>
                </div>

                <!-- Payment Form -->
                <form id="paymentForm" class="space-y-5">
                    <!-- Payment Amount -->
                    <div>
                        <label for="paymentAmount" class="block text-sm font-medium text-text-primary mb-2" id="amountLabel">
                            Payment Amount <span class="text-error">*</span>
                        </label>
                        <div class="currency-input-wrapper">
                            <span class="currency-symbol" id="currencySymbol">৳</span>
                            <input 
                                type="text" 
                                id="paymentAmount" 
                                name="paymentAmount"
                                class="input currency-input"
                                placeholder="0.00"
                                required
                                autocomplete="off"
                            >
                        </div>
                        <div class="error-message" id="amountError">
                            <i class="fas fa-exclamation-circle"></i>
                            <span id="amountErrorText">Please enter a valid amount</span>
                        </div>
                    </div>

                    <!-- Payment Date -->
                    <div>
                        <label for="paymentDate" class="block text-sm font-medium text-text-primary mb-2" id="dateLabel">
                            Payment Date <span class="text-error">*</span>
                        </label>
                        <div class="date-input">
                            <input 
                                type="date" 
                                id="paymentDate" 
                                name="paymentDate"
                                class="input"
                                required
                            >
                        </div>
                        <div class="error-message" id="dateError">
                            <i class="fas fa-exclamation-circle"></i>
                            <span id="dateErrorText">Please select a valid date</span>
                        </div>
                    </div>

                    <!-- Payment Type -->
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-3" id="typeLabel">
                            Payment Type <span class="text-error">*</span>
                        </label>
                        <div class="grid grid-cols-2 gap-3">
                            <!-- Regular Payment -->
                            <div class="payment-type-option selected rounded-lg p-4" data-type="regular">
                                <div class="flex flex-col items-center text-center gap-2">
                                    <div class="w-12 h-12 bg-primary-50 rounded-full flex items-center justify-center type-icon">
                                        <i class="fas fa-calendar-check text-primary text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-text-primary text-sm" id="regularLabel">Regular</p>
                                        <p class="text-xs text-text-secondary" id="regularDesc">Scheduled payment</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Extra Payment -->
                            <div class="payment-type-option rounded-lg p-4" data-type="extra">
                                <div class="flex flex-col items-center text-center gap-2">
                                    <div class="w-12 h-12 bg-accent-50 rounded-full flex items-center justify-center type-icon">
                                        <i class="fas fa-plus-circle text-accent text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-text-primary text-sm" id="extraLabel">Extra</p>
                                        <p class="text-xs text-text-secondary" id="extraDesc">Additional payment</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="paymentType" name="paymentType" value="regular">
                    </div>

                    <!-- Balance Indicator -->
                    <div class="balance-indicator">
                        <i class="fas fa-info-circle text-primary"></i>
                        <div class="flex-1">
                            <p class="text-xs text-text-secondary mb-1" id="remainingLabel">Remaining Balance After Payment</p>
                            <p class="text-lg font-semibold text-text-primary" id="remainingBalance">৳ 50,000</p>
                        </div>
                    </div>

                    <!-- Payment Notes (Optional) -->
                    <div>
                        <label for="paymentNotes" class="block text-sm font-medium text-text-primary mb-2" id="notesLabel">
                            Notes (Optional)
                        </label>
                        <textarea 
                            id="paymentNotes" 
                            name="paymentNotes"
                            rows="3"
                            class="input resize-none"
                            placeholder="Add any additional notes..."
                        ></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3 pt-4">
                        <button 
                            type="button" 
                            id="cancelButton"
                            class="btn-ghost flex-1"
                        >
                            <i class="fas fa-times mr-2"></i>
                            <span id="cancelText">Cancel</span>
                        </button>
                        <button 
                            type="submit" 
                            id="submitButton"
                            class="btn-primary flex-1"
                        >
                            <i class="fas fa-check mr-2"></i>
                            <span id="submitText">Record Payment</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Success Animation -->
    <div class="success-animation" id="successAnimation">
        <div class="success-checkmark">
            <i class="fas fa-check text-white text-4xl"></i>
        </div>
    </div>

    <script>
        // Language translations
        const translations = {
            en: {
                modalTitle: 'Record Payment',
                modalSubtitle: 'Add a new payment entry',
                balanceLabel: 'Current Balance',
                amountLabel: 'Payment Amount',
                dateLabel: 'Payment Date',
                typeLabel: 'Payment Type',
                regularLabel: 'Regular',
                regularDesc: 'Scheduled payment',
                extraLabel: 'Extra',
                extraDesc: 'Additional payment',
                remainingLabel: 'Remaining Balance After Payment',
                notesLabel: 'Notes (Optional)',
                cancelText: 'Cancel',
                submitText: 'Record Payment',
                amountErrorText: 'Please enter a valid amount',
                dateErrorText: 'Please select a valid date',
                exceedsBalanceError: 'Payment amount cannot exceed current balance',
                invalidAmountError: 'Please enter a valid amount greater than 0',
                futureDateError: 'Payment date cannot be in the future',
                notesPlaceholder: 'Add any additional notes...'
            },
            bn: {
                modalTitle: 'পেমেন্ট রেকর্ড করুন',
                modalSubtitle: 'নতুন পেমেন্ট এন্ট্রি যোগ করুন',
                balanceLabel: 'বর্তমান ব্যালেন্স',
                amountLabel: 'পেমেন্ট পরিমাণ',
                dateLabel: 'পেমেন্ট তারিখ',
                typeLabel: 'পেমেন্ট ধরন',
                regularLabel: 'নিয়মিত',
                regularDesc: 'নির্ধারিত পেমেন্ট',
                extraLabel: 'অতিরিক্ত',
                extraDesc: 'অতিরিক্ত পেমেন্ট',
                remainingLabel: 'পেমেন্টের পর অবশিষ্ট ব্যালেন্স',
                notesLabel: 'নোট (ঐচ্ছিক)',
                cancelText: 'বাতিল',
                submitText: 'পেমেন্ট রেকর্ড করুন',
                amountErrorText: 'অনুগ্রহ করে একটি বৈধ পরিমাণ লিখুন',
                dateErrorText: 'অনুগ্রহ করে একটি বৈধ তারিখ নির্বাচন করুন',
                exceedsBalanceError: 'পেমেন্ট পরিমাণ বর্তমান ব্যালেন্স অতিক্রম করতে পারে না',
                invalidAmountError: 'অনুগ্রহ করে ০ এর চেয়ে বড় একটি বৈধ পরিমাণ লিখুন',
                futureDateError: 'পেমেন্ট তারিখ ভবিষ্যতে হতে পারে না',
                notesPlaceholder: 'কোনো অতিরিক্ত নোট যোগ করুন...'
            }
        };

        // Get current language from localStorage or default to English
        let currentLang = localStorage.getItem('language') || 'en';

        // Mock loan data (in real app, this would come from URL params or localStorage)
        const mockLoanData = {
            id: 1,
            name: 'Personal Loan',
            lender: 'Md. Rahman',
            currentBalance: 50000,
            startDate: '01/01/2025',
            interestRate: 12
        };

        // Initialize page
        function initializePage() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate').value = today;
            document.getElementById('paymentDate').max = today;

            // Load loan data
            loadLoanData();

            // Update language
            updateLanguage();

            // Setup event listeners
            setupEventListeners();
        }

        // Load loan data
        function loadLoanData() {
            document.getElementById('loanName').textContent = mockLoanData.name;
            document.getElementById('lenderName').textContent = mockLoanData.lender;
            document.getElementById('loanStartDate').textContent = mockLoanData.startDate;
            document.getElementById('interestRate').textContent = `${mockLoanData.interestRate}% p.a.`;
            
            updateBalanceDisplay(mockLoanData.currentBalance);
        }

        // Update balance display
        function updateBalanceDisplay(balance) {
            const formattedBalance = formatCurrency(balance);
            document.getElementById('currentBalance').textContent = formattedBalance;
            document.getElementById('remainingBalance').textContent = formattedBalance;
        }

        // Format currency based on language
        function formatCurrency(amount) {
            if (currentLang === 'bn') {
                return '৳ ' + convertToBengaliNumber(amount.toLocaleString('en-IN'));
            }
            return '৳ ' + amount.toLocaleString('en-IN');
        }

        // Convert to Bengali numbers
        function convertToBengaliNumber(num) {
            const bengaliDigits = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
            return num.toString().replace(/\d/g, digit => bengaliDigits[digit]);
        }

        // Update language
        function updateLanguage() {
            const trans = translations[currentLang];
            
            document.getElementById('modalTitle').textContent = trans.modalTitle;
            document.getElementById('modalSubtitle').textContent = trans.modalSubtitle;
            document.getElementById('balanceLabel').textContent = trans.balanceLabel;
            document.getElementById('amountLabel').innerHTML = trans.amountLabel + ' <span class="text-error">*</span>';
            document.getElementById('dateLabel').innerHTML = trans.dateLabel + ' <span class="text-error">*</span>';
            document.getElementById('typeLabel').innerHTML = trans.typeLabel + ' <span class="text-error">*</span>';
            document.getElementById('regularLabel').textContent = trans.regularLabel;
            document.getElementById('regularDesc').textContent = trans.regularDesc;
            document.getElementById('extraLabel').textContent = trans.extraLabel;
            document.getElementById('extraDesc').textContent = trans.extraDesc;
            document.getElementById('remainingLabel').textContent = trans.remainingLabel;
            document.getElementById('notesLabel').textContent = trans.notesLabel;
            document.getElementById('cancelText').textContent = trans.cancelText;
            document.getElementById('submitText').textContent = trans.submitText;
            document.getElementById('amountErrorText').textContent = trans.amountErrorText;
            document.getElementById('dateErrorText').textContent = trans.dateErrorText;
            document.getElementById('paymentNotes').placeholder = trans.notesPlaceholder;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Close modal buttons
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelButton').addEventListener('click', closeModal);
            
            // Click outside modal to close
            document.getElementById('modalBackdrop').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            // Payment type selection
            document.querySelectorAll('.payment-type-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.payment-type-option').forEach(opt => 
                        opt.classList.remove('selected')
                    );
                    this.classList.add('selected');
                    document.getElementById('paymentType').value = this.dataset.type;
                });
            });

            // Payment amount input
            const amountInput = document.getElementById('paymentAmount');
            amountInput.addEventListener('input', function(e) {
                // Remove non-numeric characters except decimal point
                let value = e.target.value.replace(/[^\d.]/g, '');
                
                // Ensure only one decimal point
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }
                
                e.target.value = value;
                
                // Calculate remaining balance
                calculateRemainingBalance();
                
                // Hide error if valid
                if (value && parseFloat(value) > 0) {
                    hideError('amountError');
                }
            });

            // Date input validation
            document.getElementById('paymentDate').addEventListener('change', function() {
                const selectedDate = new Date(this.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (selectedDate > today) {
                    showError('dateError', translations[currentLang].futureDateError);
                } else {
                    hideError('dateError');
                }
            });

            // Form submission
            document.getElementById('paymentForm').addEventListener('submit', handleFormSubmit);

            // ESC key to close modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        }

        // Calculate remaining balance
        function calculateRemainingBalance() {
            const amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            const remaining = Math.max(0, mockLoanData.currentBalance - amount);
            updateBalanceDisplay(remaining);
        }

        // Show error message
        function showError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            if (message) {
                errorElement.querySelector('span').textContent = message;
            }
            errorElement.classList.add('show');
        }

        // Hide error message
        function hideError(errorId) {
            document.getElementById(errorId).classList.remove('show');
        }

        // Validate form
        function validateForm() {
            let isValid = true;
            const trans = translations[currentLang];

            // Validate amount
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            if (!amount || amount <= 0) {
                showError('amountError', trans.invalidAmountError);
                isValid = false;
            } else if (amount > mockLoanData.currentBalance) {
                showError('amountError', trans.exceedsBalanceError);
                isValid = false;
            } else {
                hideError('amountError');
            }

            // Validate date
            const dateInput = document.getElementById('paymentDate');
            const selectedDate = new Date(dateInput.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (!dateInput.value) {
                showError('dateError', trans.dateErrorText);
                isValid = false;
            } else if (selectedDate > today) {
                showError('dateError', trans.futureDateError);
                isValid = false;
            } else {
                hideError('dateError');
            }

            return isValid;
        }

        // Handle form submission
        function handleFormSubmit(e) {
            e.preventDefault();

            // Validate form
            if (!validateForm()) {
                return;
            }

            // Disable submit button
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span>Processing...</span>';

            // Get form data
            const formData = {
                loanId: mockLoanData.id,
                amount: parseFloat(document.getElementById('paymentAmount').value),
                date: document.getElementById('paymentDate').value,
                type: document.getElementById('paymentType').value,
                notes: document.getElementById('paymentNotes').value,
                timestamp: new Date().toISOString()
            };

            // Simulate API call
            setTimeout(() => {
                // Save payment to localStorage
                savePayment(formData);

                // Show success animation
                showSuccessAnimation();

                // Redirect after animation
                setTimeout(() => {
                    window.location.href = 'payment_history.html';
                }, 1500);
            }, 1000);
        }

        // Save payment to localStorage
        function savePayment(paymentData) {
            let payments = JSON.parse(localStorage.getItem('payments') || '[]');
            payments.unshift(paymentData);
            localStorage.setItem('payments', JSON.stringify(payments));

            // Update loan balance
            let loans = JSON.parse(localStorage.getItem('loans') || '[]');
            const loanIndex = loans.findIndex(l => l.id === paymentData.loanId);
            if (loanIndex !== -1) {
                loans[loanIndex].currentBalance -= paymentData.amount;
                loans[loanIndex].totalPaid = (loans[loanIndex].totalPaid || 0) + paymentData.amount;
                loans[loanIndex].lastPaymentDate = paymentData.date;
                
                // Update loan status
                if (loans[loanIndex].currentBalance <= 0) {
                    loans[loanIndex].status = 'paid';
                }
                
                localStorage.setItem('loans', JSON.stringify(loans));
            }
        }

        // Show success animation
        function showSuccessAnimation() {
            document.getElementById('successAnimation').classList.add('show');
        }

        // Close modal
        function closeModal() {
            // Navigate back to previous page or dashboard
            const referrer = document.referrer;
            if (referrer && referrer.includes(window.location.hostname)) {
                window.history.back();
            } else {
                window.location.href = 'financial_dashboard.html';
            }
        }

        // Initialize page on load
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>